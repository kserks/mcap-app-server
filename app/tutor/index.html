<!doctype html>
<html lang="ru">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, user-scalable=yes, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <link rel="stylesheet" href="./styles/cm-chessboard.css"/>

    <link rel="stylesheet" href="./assets/style/screen.css"/>
    <link rel="stylesheet" type="text/css" href="./assets/style/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"/>
  
    <title>FEN</title>
</head>
<body>
<main>
    <div class="container">
        <div id="editorContainer" class="cm-fen-editor">

            <div class="wrapper">
                <!--1-->

                <div class="chessboard" style="width: 800px;"></div>

                <div class="tools" data-event-listener="click" data-delegate="button[data-mode]" data-action="switchMode">
              
                    <!--FIGURES-->
                    <div class="fen__figuries">
                        <div class="buttons-figures buttons-figures-dark">
                            <button data-mode="bk" class="btn btn-light border-dark">
                                <i class="fas fa-fw fa-2x fa-chess-king"></i>
                            </button>
                            <button data-mode="bq" class="btn btn-light border-dark">
                                <i class="fas fa-fw fa-2x fa-chess-queen"></i>
                            </button>
                            <button data-mode="br" class="btn btn-light border-dark">
                                <i class="fas fa-fw fa-2x fa-chess-rook"></i>
                            </button>
                            <button data-mode="bb" class="btn btn-light border-dark">
                                <i class="fas fa-fw fa-2x fa-chess-bishop"></i>
                            </button>
                            <button data-mode="bn" class="btn btn-light border-dark">
                                <i class="fas fa-fw fa-2x fa-chess-knight"></i>
                            </button>
                            <button data-mode="bp" class="btn btn-light border-dark">
                                <i class="fas fa-fw fa-2x fa-chess-pawn"></i>
                            </button>
                        </div>
                        <div class="buttons-figures buttons-figures-light">
                            <button data-mode="wk" class="btn btn-dark">
                                <i class="fas fa-fw fa-2x fa-chess-king"></i>
                            </button>
                            <button data-mode="wq" class="btn btn-dark">
                                <i class="fas fa-fw fa-2x fa-chess-queen"></i>
                            </button>
                            <button data-mode="wr" class="btn btn-dark">
                                <i class="fas fa-fw fa-2x fa-chess-rook"></i>
                            </button>
                            <button data-mode="wb" class="btn btn-dark">
                                <i class="fas fa-fw fa-2x fa-chess-bishop"></i>
                            </button>
                            <button data-mode="wn" class="btn btn-dark">
                                <i class="fas fa-fw fa-2x fa-chess-knight"></i>
                            </button>
                            <button data-mode="wp" class="btn btn-dark">
                                <i class="fas fa-fw fa-2x fa-chess-pawn"></i>
                            </button>
                        </div>
                    </div>


                    <!--Add remove-->
                    <div class="buttons mb-1 buttons__wrapper">
                        <div style="display: flex;  width: 100%;">
                            <button data-mode="move" class="fen__btn">
                                <i class="fas fa-hand-pointer"></i> 
                            </button>
                            <button data-mode="erase" class="fen__btn">
                                <i class="fas fa-eraser"></i> 
                            </button>
                            <button id="flipOrientationBtn" class="fen__btn scale15">
                                 <i class="fas fa-adjust"></i>

                            </button>
                            <button id="setMarkerBtn" class="fen__btn scale15">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-circle" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                </svg>
                            </button>
                            <button id="clearMarkersBtn" class="fen__btn scale15">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-dash-circle" viewBox="0 0 16 16">
                                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                    <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z"/>
                                </svg>
                            </button>
                     </div>
                        <!--theme-->
                        <div style="display: flex; justify-content: flex-end; width: 100%;">
                                
                            <button id="default" class="fen__btn css-theme">
                                <div class="style-circle" style="  background: #c5a076;"></div>
                            </button>
                            <button id="green" class="fen__btn css-theme">
                                <div class="style-circle" style="  background: #4c946a;"></div>
                            </button>
                            <button id="blue" class="fen__btn css-theme">
                                <div class="style-circle" style="  background: #678fb1;"></div>
                            </button>
                            <button id="chess-club" class="fen__btn css-theme" style="margin-right: 0">
                                <div class="style-circle" style="  background: #af6b3f;"></div>
                            </button>
                        </div>
                    <!--Markers-->

                        
                        <select style="display: none;" class="form-control fen-input-output" id="positionSetUp"></select>

                    </div>
                    <!--FEN input-->
                    <div class="fen__wrapper">
                            <div class="fen__btn" id='fen__btn'>
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sd-card" viewBox="0 0 16 16">
                                    <path d="M6.25 3.5a.75.75 0 0 0-1.5 0v2a.75.75 0 0 0 1.5 0v-2zm2 0a.75.75 0 0 0-1.5 0v2a.75.75 0 0 0 1.5 0v-2zm2 0a.75.75 0 0 0-1.5 0v2a.75.75 0 0 0 1.5 0v-2zm2 0a.75.75 0 0 0-1.5 0v2a.75.75 0 0 0 1.5 0v-2z"/>
                                    <path fill-rule="evenodd" d="M5.914 0H12.5A1.5 1.5 0 0 1 14 1.5v13a1.5 1.5 0 0 1-1.5 1.5h-9A1.5 1.5 0 0 1 2 14.5V3.914c0-.398.158-.78.44-1.06L4.853.439A1.5 1.5 0 0 1 5.914 0zM13 1.5a.5.5 0 0 0-.5-.5H5.914a.5.5 0 0 0-.353.146L3.146 3.561A.5.5 0 0 0 3 3.914V14.5a.5.5 0 0 0 .5.5h9a.5.5 0 0 0 .5-.5v-13z"/>
                                </svg>

                            </div>
                            <div class="fen__input">
                                <input type="text" class="form-control fen-input-output" id="fenInputOutput">
  
                            </div>
                             <div class="fen__btn" id="pause" style="margin-left: 10px; margin-right: 0px;"><i class="fas fa-chess-board"></i></div>
                            
                     </div>
                    <!--fen list-->
                    <div class="fen__list"></div>

                </div>
            </div>
        </div>

    </div>
</main>
<div class="fen__save">
    <div class="fen__save-remove">x</div>
    <div class="fen__save-wrapper">
        <div class="fen__save-wrapper-input">
            <input class="fen__save-input" type="text" placeholder="Название">
            <div class="fen__save-btn">Сохранить</div>
        </div>
        <div class="fen__save-fen"></div>
    </div>
</div>



<script src="./lib/jquery.min.js"></script>
<script src="./lib/bootstrap.bundle.js"></script>
<script type="module">

import { FenEditor } from "./src/FenEditor.js"

var player = null
var rndID = new Date().getTime()
try {
      window.mcefQuery({
        request: "info",
        persistent: true,
        onSuccess:response=>{
          player = JSON.parse(response)
          load()
        }
      });
 } catch (err) {
      player = {
        name: 'mcap_uknown',
        uuid: new Date().toLocaleString()
      }
      load()
}


const FEN_STORE = [
        {
            title: 'Пустая доска',
            value: '8/8/8/8/8/8/8/8 w - - 0 1'
        },
        {
            title: 'Стартовая позиция',
            value: 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1'
        }
]

const editor = new FenEditor(document.getElementById("editorContainer"), {
        onChange: function(fen, valid) {
            //console.log("onChange callback", fen, valid)
        },
        fen: '8/8/8/8/8/8/8/8 w - - 0 1',
        
    })
function init(){

    renderFenList()
//.chessboard-theme__green

    const { chessboard } = editor


    $('#flipOrientationBtn').on('click', function () {
        chessboard.setOrientation(chessboard.getOrientation() === 'w' ? 'b' : 'w')
    })
    $('#clearMarkersBtn').on('click', function () {
        chessboard.removeMarkers(undefined, undefined)
        editor.state.mode = 'move';
    })
    $('#setMarkerBtn').on('click', function () {
        editor.state.mode = 'markers';
    })
    
    $('#fen__btn').on('click', function (){
        $('.fen__save-fen').html(editor.state.fen)
        $('.fen__save').css('display', 'flex')
        $('.fen__save-input').focus() 
    })
    $('.fen__save-remove').on('click', function (){
        $('.fen__save').hide()
    })
    $('.fen__save-btn').on('click', function (){
        let title = $('.fen__save-input').val()
        if(title!==''){
            let index = FEN_STORE.map(f=>{
                            if(f.title===title) return title
                        }).indexOf(title)
            if(index==-1){
                FEN_STORE.push({ title, value: editor.state.fen })
            }
            else{
                FEN_STORE[index] = { title, value: editor.state.fen }
            }

            renderFenList()
            save()
        }

        $('.fen__save').hide()
    })
/********/
    $('.fen__list').on('click', '.fen__list--item-data', function (){
       editor.state.fen = $(this).data('value')
    })

     $('.fen__list').on('click', '.fen__list--item-remove', function (){
        let index = $(this).data('index')
        FEN_STORE.splice(index, 1)
        save()
        editor.state.fen = FEN_STORE[0].value
        renderFenList()
     })
}


function renderFenList (){
    $('.fen__list').empty()
    FEN_STORE.map((f, i)=>{
        let $option = $(`<div class="fen__list--item"><span class="fen__list--item-data" data-value="${f.value}">${f.title}</span><span data-index='${i}' class='fen__list--item-remove'>x</span></div>`)
        $('.fen__list').append($option)
    })
}

function save (){

  fetch('/tutor/save', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json;charset=utf-8'
    },
    body: JSON.stringify({ playerName: player.name, data: FEN_STORE }, null, 2)
  })
  .then(r=>{
    console.log('Сохранено')
  })
}
function load(){

    fetch(`/tutor/${player.name}__fen_store.json`)
        .then(r=>r.json())
        .then(data=>{
            if(data){
          
                FEN_STORE = data

            }
           init()
        })
        .catch(err=>{
           init()
        })
    
}

$('.css-theme').on('click', function (){
   let id = $(this).attr('id')
    localStorage.setItem('style', id)
    window.theme = id
    location.reload()
})


/**
 * PAUSE
 */

let activePause = false
let fenPausedData = null
$('#pause').on('click', function (){

  if(fenPausedData){

      //activePause = false
      $(this).removeClass('fen__btn--active')
      editor.state.fen = fenPausedData
      fenPausedData = null
  }
  else{
      //activePause = true
      $(this).addClass('fen__btn--active')
      fenPausedData = editor.state.fen
  }


})


</script>
</body>
</html>